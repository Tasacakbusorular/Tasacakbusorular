<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="ta≈üacakbudeniz,ta≈üacak bu deniz,deniz, bu ,ta≈üacak, ≈üa≈üacak bu sorular , ta≈üacakbusorular ,ta≈üacak budeniz soru, ta≈üacak bu deniz test, ta≈üacak bu deniz yarƒ±≈üma , ta≈üacak bu test , adil ko√ßari test,esme fƒ±rtƒ±na test, oru√ß Tokat , ≈ûerif Tokat , zarife tokat , hicran Tokat , iso Tokat , beh√ßet Tokat ,zarife furtuna , oru√ß, zarife , ≈üerif, adil , ko√ßari , furtuna , sevcan, sevcan Tokat , g√∂khan Tokat, g√∂khan, ≈üerif furtuna, ≈üirin, ≈üirin furtuna , esme , adil">
    <title>Ta≈üacak Bu Sorular </title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YBB3VZW6NJ"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-YBB3VZW6NJ');
    </script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Confetti Effect -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
  <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; overflow-x: hidden; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .wave-bg {
            background: radial-gradient(circle at top, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
            position: relative;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }
        .btn-hover { transition: all 0.2s; }
        .btn-hover:active { transform: scale(0.96); }
        .progress-fill { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .correct-glow { box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); }
        .wrong-glow { box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }

        .fixed-disclaimer {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(8px);
            border-top: 1px solid rgba(234, 179, 8, 0.2);
        }

        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 80px;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
            border: 1px solid #4ade80;
            background: rgba(22, 101, 52, 0.9);
            backdrop-filter: blur(4px);
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 100px;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

    <div id="app" class="wave-bg flex flex-col items-center p-4 sm:p-8 pb-24">
        <div class="flex flex-col items-center justify-center h-screen">
            <div class="loader mb-4"></div>
            <p class="text-slate-400 animate-pulse">B√∂l√ºmler GitHub'dan √áekiliyor...</p>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"><i data-lucide="check" class="inline w-4 h-4 mr-1"></i> ƒ∞≈ülem Ba≈üarƒ±lƒ±</div>

    <!-- Disclaimer -->
    <div class="fixed-disclaimer fixed bottom-0 left-0 w-full z-50 py-3 px-4 text-center shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
        <div class="max-w-2xl mx-auto flex items-start justify-center gap-3 text-xs sm:text-sm text-slate-300">
            <i data-lucide="bot" class="text-yellow-500 shrink-0 mt-0.5" width="16" height="16"></i>
            <p>
                <span class="text-yellow-500 font-bold">YAPAY ZEKA UYARISI:</span> 
                Bu sorular AI ile √ºretilmi≈ütir. Karakter ili≈ükilerinde mantƒ±k hatalarƒ± olabilir.
            </p>
        </div>
    </div>

    <script>
        // =================================================================
        // √ñNEMLƒ∞ AYAR: A≈ûAƒûIDAKƒ∞ URL'Yƒ∞ KENDƒ∞ APPS SCRIPT URL'Nƒ∞ZLE DEƒûƒ∞≈ûTƒ∞Rƒ∞N
        // Eƒüer URL girilmezse veya hatalƒ±ysa sistem √áEVRƒ∞MDI≈ûI MODDA √ßalƒ±≈üƒ±r.
        // =================================================================
        const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzIcfSzA5Nv6YH2VQ6DEsSSOwaqJ73LF9NH0oqtpdKTFFVI_LDTGzA5rY8ffPIX6AJt/exec"; 
        // =================================================================

        const GITHUB_USER = "Tasacakbusorular";
        const GITHUB_REPO = "Tasacakbusorular";
        const GITHUB_FOLDER = ""; 

        const POINTS = { kolay: 10, orta: 20, zor: 30 };

        const state = {
            view: 'loading', 
            gameMode: null, 
            episodeList: [], 
            activeEpisodeMeta: null,
            activeEpisodeData: null,
            activeDifficulty: null,
            quiz: {
                questions: [],
                currentQIndex: 0,
                score: 0,
                correctCount: 0,
                streak: 0,
                history: [] 
            },
            isReviewing: false, 
            username: localStorage.getItem('ts_quiz_username') || '',
            userid: localStorage.getItem('ts_quiz_userid') || '',
            userProgress: JSON.parse(localStorage.getItem('ts_quiz_gh_progress')) || { totalScore: 0 },
            sharedData: null,
            leaderboard: [] 
        };

        // --- BACKEND ENTEGRASYON ---

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function checkInactivity() {
            const lastLogin = localStorage.getItem('ts_quiz_last_login');
            if (lastLogin) {
                const diffTime = Math.abs(new Date() - new Date(lastLogin));
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                if (diffDays > 3) {
                    console.log("3 g√ºnden fazla giri≈ü yapƒ±lmadƒ±, veriler sƒ±fƒ±rlanƒ±yor.");
                    localStorage.removeItem('ts_quiz_username');
                    localStorage.removeItem('ts_quiz_userid');
                    localStorage.removeItem('ts_quiz_gh_progress');
                    state.username = '';
                    state.userid = '';
                    state.userProgress = { totalScore: 0 };
                    return true; 
                }
            }
            localStorage.setItem('ts_quiz_last_login', new Date().toISOString());
            return false;
        }

        async function sendToBackend(action, data = {}) {
            // 1. URL Kontrol√º: Eƒüer placeholder duruyorsa offline moda ge√ß
            if (!APP_SCRIPT_URL || APP_SCRIPT_URL.includes("BURAYA")) {
                console.warn("‚ö†Ô∏è Backend URL ayarlanmamƒ±≈ü. √áevrimdƒ±≈üƒ± modda devam ediliyor.");
                // Sanki ba≈üarƒ±lƒ± olmu≈ü gibi sahte bir yanƒ±t d√∂n√ºyoruz ki uygulama kilitlenmesin
                return { status: "success", message: "Offline mode", data: [] };
            }

            try {
                const form = new FormData();
                form.append('action', action);
                for (const key in data) {
                    form.append(key, data[key]);
                }

                console.log(`üì§ G√∂nderiliyor: ${action}`, data);

                const res = await fetch(APP_SCRIPT_URL, {
                    method: 'POST',
                    body: form
                });
                
                const json = await res.json();
                console.log(`üì• Yanƒ±t:`, json);
                return json;

            } catch (err) {
                console.error("‚ùå Backend baƒülantƒ± hatasƒ±:", err);
                // Hata durumunda kritik bir hata fƒ±rlatmak yerine "network_error" d√∂n√ºyoruz
                // B√∂ylece aray√ºzde "Offline devam ediliyor" mantƒ±ƒüƒ±nƒ± i≈ületebiliriz.
                return { status: "network_error", message: "Sunucuya ula≈üƒ±lamadƒ±." };
            }
        }

        async function registerUserBackend(name) {
            if (!state.userid) {
                state.userid = generateUUID();
                localStorage.setItem('ts_quiz_userid', state.userid);
            }

            const result = await sendToBackend('register', {
                username: name,
                userid: state.userid
            });

            // Eƒüer aƒü hatasƒ± veya offline mod ise, yerel olarak devam etmeye izin ver
            if (result.status === "network_error" || (result.status === "success" && result.message === "Offline mode")) {
                console.log("üåê Sunucu eri≈üilemiyor, yerel kayƒ±t ile devam ediliyor.");
                return true; 
            }

            if (result && result.status === "error") {
                alert("‚ö†Ô∏è " + result.message); // Sadece sunucudan "ƒ∞sim alƒ±nmƒ±≈ü" hatasƒ± gelirse durdur
                return false;
            } 
            
            return true;
        }

        async function fetchLeaderboard() {
            showToast("Sƒ±ralama y√ºkleniyor...", false);
            const result = await sendToBackend('getLeaderboard');
            
            // Toast'ƒ± temizle
            const x = document.getElementById("toast");
            x.className = x.className.replace("show", "");

            if (result && result.status === 'success') {
                state.leaderboard = result.data;
                renderLeaderboardModal();
            } else if (result && result.message === "Offline mode") {
                alert("Liderlik tablosu i√ßin Backend URL ayarƒ± yapƒ±lmalƒ±dƒ±r.");
            } else {
                showToast("Sunucuya eri≈üilemedi.", true);
            }
        }

        // --- URL PAYLA≈ûIM ---

        function b64EncodeUnicode(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
                function toSolidBytes(match, p1) {
                    return String.fromCharCode('0x' + p1);
            }));
        }

        function b64DecodeUnicode(str) {
            return decodeURIComponent(atob(str).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }

        function checkUrlForShare() {
            const urlParams = new URLSearchParams(window.location.search);
            const shareCode = urlParams.get('share');
            if (shareCode) {
                try {
                    const decoded = JSON.parse(b64DecodeUnicode(shareCode));
                    state.sharedData = decoded;
                    return true;
                } catch (e) { return false; }
            }
            return false;
        }

        function generateShareLink() {
            const shareObj = {
                u: state.username,
                s: state.userProgress.totalScore,
                d: new Date().toLocaleDateString()
            };
            const code = b64EncodeUnicode(JSON.stringify(shareObj));
            let url = "";
            try {
                url = `${window.location.origin}${window.location.pathname}?share=${code}`;
            } catch(e) {
                url = `https://tasacakbusorular.github.io/?share=${code}`;
            }
            
            navigator.clipboard.writeText(url).then(() => {
                showToast("Link kopyalandƒ±! Arkada≈üƒ±na g√∂nder.");
            }).catch(() => {
                const textArea = document.createElement("textarea");
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast("Link kopyalandƒ±!");
                } catch (err) {}
                document.body.removeChild(textArea);
            });
        }

        function showToast(msg, autoHide = true) {
            const x = document.getElementById("toast");
            x.innerHTML = `<i data-lucide="info" class="inline w-4 h-4 mr-2"></i> ${msg}`;
            x.className = "show";
            if(autoHide) setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- GITHUB FETCH ---

        async function fetchEpisodeList() {
            try {
                const path = GITHUB_FOLDER ? `/${GITHUB_FOLDER}` : '';
                const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents${path}`;
                
                const res = await fetch(apiUrl);
                if (!res.ok) throw new Error(`GitHub: ${res.status}`);
                
                const data = await res.json();
                if (!Array.isArray(data)) throw new Error("Format hatasƒ±");

                state.episodeList = data
                    .filter(item => item.name.endsWith(".json"))
                    .map((item, index) => ({
                        id: `ep_${index + 1}`, 
                        titleDisplay: item.name.replace('.json', '').replace(/_/g, ' ').toUpperCase(), 
                        rawUrl: item.download_url, 
                        fileName: item.name
                    }));

                if (checkUrlForShare()) {
                    state.view = 'sharedProfile';
                } else if (!state.username) {
                    state.view = 'welcome';
                } else {
                    state.view = 'home';
                }
                render();

            } catch (error) {
                document.getElementById('app').innerHTML = `
                    <div class="text-center text-red-400 mt-20">
                        <h2 class="text-xl font-bold">Veri √áekme Hatasƒ±</h2>
                        <button onclick="location.reload()" class="mt-4 bg-slate-700 px-4 py-2 rounded text-white">Tekrar Dene</button>
                    </div>
                `;
            }
        }

        async function loadEpisodeContent(epMeta) {
            const btnContent = document.getElementById(`btn-content-${epMeta.id}`);
            if(btnContent) btnContent.innerHTML = '<div class="loader" style="width:20px; height:20px; border-width:2px"></div>';

            try {
                const response = await fetch(epMeta.rawUrl);
                if (!response.ok) throw new Error("Dosya okunamadƒ±");
                
                const jsonData = await response.json();
                state.activeEpisodeData = jsonData; 
                state.activeEpisodeMeta = epMeta;    

                const storageId = jsonData.id || epMeta.id; 
                
                if (!state.userProgress[storageId]) {
                    state.userProgress[storageId] = { 
                        unlocked: { kolay: true, orta: false, zor: false }, 
                        scores: { kolay: 0, orta: 0, zor: 0 } 
                    };
                    saveProgress();
                }

                setView('levelSelect');

            } catch (err) {
                alert("Hata: " + err.message);
                render(); 
            }
        }

        // --- OYUN MANTIƒûI ---

        function saveProgress() {
            localStorage.setItem('ts_quiz_gh_progress', JSON.stringify(state.userProgress));
        }

        async function setUsername() {
            const input = document.getElementById('usernameInput');
            const val = input.value.trim();
            if (val.length < 3) {
                alert("L√ºtfen en az 3 karakterli bir isim giriniz.");
                return;
            }

            const btn = document.querySelector("button[onclick='setUsername()']");
            const originalText = btn.innerText;
            btn.innerText = "Baƒülanƒ±yor...";
            btn.disabled = true;

            // Backend Kaydƒ± (Offline mod desteƒüi ile)
            const success = await registerUserBackend(val);
            
            btn.innerText = originalText;
            btn.disabled = false;

            if (!success) return; 

            state.username = val;
            localStorage.setItem('ts_quiz_username', val);
            
            try { window.history.replaceState({}, document.title, window.location.pathname); } catch (e) {}

            setView('home');
        }

        function init() {
            const wasInactive = checkInactivity();
            
            if (!wasInactive && state.username && state.userid) {
                console.log("üîÑ Sessiz senkronizasyon yapƒ±lƒ±yor...");
                registerUserBackend(state.username).then(() => {
                    console.log("‚úÖ Senkronizasyon tamam.");
                });
            }

            fetchEpisodeList(); 
        }

        function startQuiz(difficulty) {
            const epData = state.activeEpisodeData;
            const storageId = epData.id || state.activeEpisodeMeta.id;
            
            if (state.gameMode === 'story' && !state.userProgress[storageId].unlocked[difficulty]) return;

            let pool = null;
            if (epData[difficulty]) pool = epData[difficulty];
            else if (epData.questions && epData.questions[difficulty]) pool = epData.questions[difficulty];

            if (!pool || pool.length === 0) {
                alert("Soru bulunamadƒ±!");
                return;
            }

            state.quiz.questions = [...pool].sort(() => 0.5 - Math.random()).slice(0, 10);
            
            state.activeDifficulty = difficulty;
            state.quiz.currentQIndex = 0;
            state.quiz.score = 0;
            state.quiz.correctCount = 0;
            state.quiz.streak = 0;
            state.quiz.history = []; 
            state.isReviewing = false;
            
            setView('quiz');
        }

        function handleAnswer(optIndex) {
            const allBtns = document.querySelectorAll('.option-btn');
            let alreadyClicked = false;
            allBtns.forEach(btn => {
                if(btn.disabled) alreadyClicked = true;
                btn.disabled = true; 
            });
            if(alreadyClicked) return;

            const currentQ = state.quiz.questions[state.quiz.currentQIndex];
            const selectedOpt = currentQ.secenekler[optIndex];
            const optLetter = String.fromCharCode(65 + optIndex);
            const isCorrect = optLetter === currentQ.dogru;

            state.quiz.history.push({
                question: currentQ.soru,
                options: currentQ.secenekler,
                userOpt: optLetter,
                correctOpt: currentQ.dogru,
                isCorrect: isCorrect,
                userOptText: selectedOpt
            });

            const btn = document.getElementById(`btn-${optIndex}`);
            
            if (isCorrect) {
                state.quiz.score += POINTS[state.activeDifficulty] + (state.quiz.streak * 2); 
                state.quiz.correctCount++;
                state.quiz.streak++;
                btn.classList.add('bg-green-600', 'border-green-400', 'correct-glow');
                btn.innerHTML += ` <i data-lucide="check" class="ml-auto"></i>`;
            } else {
                state.quiz.streak = 0;
                btn.classList.add('bg-red-600', 'border-red-400', 'wrong-glow');
                btn.innerHTML += ` <i data-lucide="x" class="ml-auto"></i>`;
                
                const correctIndex = currentQ.dogru.charCodeAt(0) - 65;
                const correctBtn = document.getElementById(`btn-${correctIndex}`);
                if(correctBtn) {
                    correctBtn.classList.add('bg-green-600/50', 'border-green-400/50');
                }
            }

            lucide.createIcons();

            setTimeout(() => {
                if (state.quiz.currentQIndex < state.quiz.questions.length - 1) {
                    state.quiz.currentQIndex++;
                    renderQuiz();
                } else {
                    finishQuiz();
                }
            }, 1200);
        }

        async function finishQuiz() {
            const successRate = (state.quiz.correctCount / state.quiz.questions.length) * 100;
            const isPassed = successRate >= 60;
            const epData = state.activeEpisodeData;
            const storageId = epData.id || state.activeEpisodeMeta.id;
            const dif = state.activeDifficulty;

            state.userProgress.totalScore += state.quiz.score;
            
            if (state.quiz.score > state.userProgress[storageId].scores[dif]) {
                state.userProgress[storageId].scores[dif] = state.quiz.score;
            }

            if (state.gameMode === 'story' && isPassed) {
                if (dif === 'kolay') state.userProgress[storageId].unlocked.orta = true;
                if (dif === 'orta') state.userProgress[storageId].unlocked.zor = true;
            }

            saveProgress();

            // BACKEND: Skoru g√ºncelle
            if (state.userid) {
                console.log("üèÅ Quiz bitti, skor g√ºncelleniyor:", state.userProgress.totalScore);
                sendToBackend('updateScore', {
                    userid: state.userid,
                    score: state.userProgress.totalScore
                }).then(res => {
                    // Offline mode veya hata durumunda tekrar denemeye √ßalƒ±≈üƒ±r ama kullanƒ±cƒ±yƒ± darlamaz
                    if(res && res.status === 'error') {
                        console.warn("Kullanƒ±cƒ± backend'de yok veya hata var.");
                        // Burada retry logic olabilir ama basitlik i√ßin ge√ßiyoruz
                    }
                });
            }

            setView('result');

            if (isPassed) {
                triggerConfetti();
            }
        }

        function triggerConfetti() {
            var duration = 3000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                var particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        function randomInRange(min, max) { return Math.random() * (max - min) + min; }

        function setView(viewName) {
            state.view = viewName;
            render();
        }

        function toggleReview() {
            state.isReviewing = !state.isReviewing;
            renderResult(document.getElementById('app')); 
        }

        async function resetData() {
            if(confirm('T√ºm ilerlemeniz, hesabƒ±nƒ±z ve puanlarƒ±nƒ±z silinecek. Emin misiniz?')) {
                
                // Backend'den silme i≈ülemi (Sadece URL varsa dene)
                if(state.userid && APP_SCRIPT_URL && !APP_SCRIPT_URL.includes("BURAYA")) {
                    showToast("Hesap sunucudan siliniyor...", false);
                    try {
                        await sendToBackend('deleteUser', { userid: state.userid });
                    } catch(e) {
                        console.error("Silme hatasƒ±:", e);
                    }
                }

                localStorage.clear();
                try { location.reload(); } catch(e) { 
                    state.username = ""; 
                    state.userid = "";
                    state.userProgress = { totalScore: 0 }; 
                    setView('welcome'); 
                }
            }
        }

        function renderLeaderboardModal() {
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay fade-in";
            modal.innerHTML = `
                <div class="bg-slate-900 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl relative">
                    <button onclick="this.parentElement.parentElement.remove()" class="absolute top-4 right-4 text-slate-400 hover:text-white">
                        <i data-lucide="x" width="24"></i>
                    </button>
                    
                    <h2 class="text-2xl font-bold text-center mb-6 text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">
                        üèÜ Liderlik Tablosu
                    </h2>

                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                        ${state.leaderboard.length > 0 ? state.leaderboard.map((user, idx) => `
                            <div class="flex items-center justify-between p-3 rounded-xl ${user.username === state.username ? 'bg-blue-900/40 border border-blue-500/50' : 'bg-slate-800/50 border border-slate-700/50'}">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 flex items-center justify-center rounded-full font-bold ${idx < 3 ? 'bg-yellow-500 text-black' : 'bg-slate-700 text-slate-400'}">
                                        ${idx + 1}
                                    </div>
                                    <div class="font-bold ${user.username === state.username ? 'text-blue-300' : 'text-white'}">
                                        ${user.username}
                                    </div>
                                </div>
                                <div class="font-mono text-yellow-400 font-bold">
                                    ${user.score.toLocaleString()}
                                </div>
                            </div>
                        `).join('') : '<div class="text-center text-slate-500">Hen√ºz veri yok veya √ßevrimdƒ±≈üƒ± moddasƒ±nƒ±z.</div>'}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        // --- RENDER MOTORU ---
        
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = ''; 

            if (state.view === 'welcome') renderWelcome(app);
            else if (state.view === 'sharedProfile') renderSharedProfile(app);
            else if (state.view === 'home') renderHome(app);
            else if (state.view === 'episodeSelect') renderEpisodeSelect(app);
            else if (state.view === 'levelSelect') renderLevelSelect(app);
            else if (state.view === 'quiz') renderQuiz(app);
            else if (state.view === 'result') renderResult(app);

            lucide.createIcons();
        }

        function renderWelcome(container) {
            container.innerHTML = `
                <div class="glass-panel p-8 rounded-2xl w-full max-w-md text-center fade-in mt-10">
                    <div class="inline-flex items-center justify-center p-4 bg-blue-500/10 rounded-full mb-6 ring-1 ring-blue-500/50">
                        <i data-lucide="user-plus" class="text-blue-400 w-8 h-8"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">Aramƒ±za Katƒ±l</h2>
                    <p class="text-slate-400 mb-6">Skorlarƒ±nƒ± kaydetmek ve liderlik tablosuna girmek i√ßin bir takma ad belirle.</p>
                    
                    <div class="relative mb-4">
                        <input type="text" id="usernameInput" placeholder="Takma Adƒ±n..." 
                            class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all text-center font-bold"
                            maxlength="15"
                            onkeypress="if(event.key === 'Enter') setUsername()">
                    </div>

                    <button onclick="setUsername()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold transition-all shadow-lg shadow-blue-900/20 btn-hover">
                        Ba≈üla
                    </button>
                </div>
            `;
        }

        function renderSharedProfile(container) {
            const d = state.sharedData;
            container.innerHTML = `
                 <div class="glass-panel p-8 rounded-2xl w-full max-w-md text-center fade-in mt-10 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-yellow-500 via-orange-500 to-yellow-500"></div>
                    <p class="text-yellow-400 text-xs font-bold uppercase tracking-widest mb-4">MEYDAN OKUMA</p>
                    <div class="mb-6">
                        <div class="w-20 h-20 bg-slate-800 rounded-full mx-auto flex items-center justify-center border-4 border-slate-700 mb-3 shadow-xl">
                            <span class="text-3xl font-black text-slate-400">${d.u.charAt(0).toUpperCase()}</span>
                        </div>
                        <h2 class="text-3xl font-bold text-white mb-1">${d.u}</h2>
                        <p class="text-slate-400 text-sm">Bir skor payla≈ütƒ±.</p>
                    </div>
                    <div class="bg-slate-900/50 rounded-xl p-6 mb-8 border border-slate-700/50">
                        <p class="text-slate-500 text-xs font-bold uppercase mb-1">TOPLAM SKOR</p>
                        <div class="text-5xl font-black text-yellow-400 drop-shadow-md tracking-tight">${d.s.toLocaleString()}</div>
                    </div>
                    <button onclick="state.username ? setView('home') : setView('welcome')" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold transition-all shadow-lg shadow-blue-900/20 btn-hover flex items-center justify-center gap-2">
                        <i data-lucide="swords" width="20"></i> ${state.username ? 'Meydan Oku' : 'Sen de Oyna'}
                    </button>
                </div>
            `;
        }

        function renderHome(container) {
            container.innerHTML = `
                <header class="mt-8 mb-8 text-center fade-in">
                    <div class="inline-flex items-center justify-center p-3 bg-blue-500/10 rounded-full mb-4 border border-blue-500/30">
                        <i data-lucide="waves" class="text-blue-400 w-8 h-8"></i>
                    </div>
                    <h1 class="text-4xl sm:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-cyan-300 to-blue-500 mb-2 drop-shadow-lg">
                        Ta≈üacak Bu Deniz
                    </h1>
                    <p class="text-slate-400 text-lg tracking-wide">Ho≈ü geldin, <span class="text-white font-bold">${state.username}</span></p>
                </header>

                <div class="glass-panel p-6 rounded-2xl w-full max-w-md mb-8 text-center fade-in border-t border-white/10" style="animation-delay: 0.1s">
                    <div class="flex justify-between items-center mb-4">
                         <p class="text-slate-400 text-xs font-bold uppercase tracking-wider text-left">Toplam Puan</p>
                         <div class="flex gap-2">
                             <button onclick="fetchLeaderboard()" class="text-[10px] bg-yellow-600/20 text-yellow-400 px-2 py-1 rounded border border-yellow-500/30 hover:bg-yellow-600 hover:text-white transition-colors flex items-center gap-1">
                                <i data-lucide="bar-chart-2" width="10"></i> Lƒ∞DERLER
                             </button>
                             <button onclick="generateShareLink()" class="text-[10px] bg-green-600/20 text-green-400 px-2 py-1 rounded border border-green-500/30 hover:bg-green-600 hover:text-white transition-colors flex items-center gap-1">
                                <i data-lucide="share-2" width="10"></i> PAYLA≈û
                             </button>
                         </div>
                    </div>
                   
                    <div class="text-5xl font-black text-yellow-400 flex items-center justify-center gap-3 drop-shadow-md mb-2">
                        <i data-lucide="trophy" class="w-8 h-8"></i> ${state.userProgress.totalScore.toLocaleString()}
                    </div>
                </div>

                <div class="grid gap-4 w-full max-w-md fade-in" style="animation-delay: 0.2s">
                    <button onclick="state.gameMode='story'; setView('episodeSelect')" 
                        class="glass-panel p-6 rounded-xl hover:bg-blue-600/20 hover:border-blue-400/50 transition-all text-left group btn-hover relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                                    <div class="bg-blue-500/20 p-2 rounded-lg"><i data-lucide="book-open" class="text-blue-400 w-5 h-5"></i></div>
                                    Hikaye Modu
                                </h2>
                                <p class="text-slate-400 text-sm mt-1 ml-11">B√∂l√ºmleri sƒ±rayla tamamla.</p>
                            </div>
                            <i data-lucide="chevron-right" class="text-slate-500 group-hover:text-white group-hover:translate-x-1 transition-transform"></i>
                        </div>
                    </button>

                    <button onclick="state.gameMode='free'; setView('episodeSelect')" 
                        class="glass-panel p-6 rounded-xl hover:bg-emerald-600/20 hover:border-emerald-400/50 transition-all text-left group btn-hover relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-emerald-600/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                                    <div class="bg-emerald-500/20 p-2 rounded-lg"><i data-lucide="layers" class="text-emerald-400 w-5 h-5"></i></div>
                                    Serbest Mod
                                </h2>
                                <p class="text-slate-400 text-sm mt-1 ml-11">ƒ∞stediƒüin b√∂l√ºmden ba≈üla.</p>
                            </div>
                            <i data-lucide="chevron-right" class="text-slate-500 group-hover:text-white group-hover:translate-x-1 transition-transform"></i>
                        </div>
                    </button>
                    
                    <div class="flex justify-between items-center mt-6 px-2">
                        <button onclick="resetData()" class="text-xs text-red-400/50 hover:text-red-400 underline transition-colors">
                            √áƒ±kƒ±≈ü Yap / Sƒ±fƒ±rla
                        </button>
                        <div class="text-[10px] text-slate-600 font-mono">
                            v3.3 ‚Ä¢ Offline Mode Fix
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEpisodeSelect(container) {
            let html = `
                <div class="w-full max-w-md fade-in">
                    <button onclick="setView('home')" class="mb-6 text-slate-400 hover:text-white flex items-center gap-2 text-sm transition-colors">
                        <div class="bg-slate-800 p-1 rounded-full"><i data-lucide="arrow-left" width="16"></i></div> Ana Men√º
                    </button>
                    <h2 class="text-2xl font-bold mb-6 text-center flex items-center justify-center gap-2">
                        <i data-lucide="library" class="text-purple-400"></i> B√∂l√ºmler
                    </h2>
                    <div class="grid gap-4 pb-10">
            `;

            if (state.episodeList.length === 0) {
                html += `
                    <div class="text-center text-slate-500 p-8 glass-panel rounded-xl">
                        <i data-lucide="folder-open" class="mx-auto mb-2 opacity-50"></i>
                        <p>Hen√ºz b√∂l√ºm y√ºklenmemi≈ü.</p>
                    </div>`;
            } else {
                state.episodeList.forEach((ep, index) => {
                    const epString = JSON.stringify(ep).replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                    const delay = index * 0.05;
                    html += `
                        <button onclick='loadEpisodeContent(${epString})' 
                            class="glass-panel p-5 rounded-xl hover:border-blue-400 hover:bg-slate-800 transition-all text-left group btn-hover w-full relative overflow-hidden"
                            style="animation: fadeIn 0.4s ease-out forwards; animation-delay: ${delay}s; opacity: 0; transform: translateY(10px);">
                            <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500/0 group-hover:bg-blue-500 transition-colors"></div>
                            <div class="flex justify-between items-center pl-2">
                                <div>
                                    <h3 class="text-lg font-bold text-white group-hover:text-blue-200 transition-colors">${ep.titleDisplay}</h3>
                                    <p class="text-slate-400 text-xs mt-1 font-mono opacity-60">${ep.fileName}</p>
                                </div>
                                <div id="btn-content-${ep.id}" class="bg-slate-700/50 p-2 rounded-full text-slate-400 group-hover:bg-blue-600 group-hover:text-white transition-all transform group-hover:rotate-12">
                                    <i data-lucide="play" width="20" class="fill-current"></i>
                                </div>
                            </div>
                        </button>
                    `;
                });
            }
            html += `</div></div>`;
            container.innerHTML = html;
        }

        function renderLevelSelect(container) {
            const epData = state.activeEpisodeData; 
            const storageId = epData.id || state.activeEpisodeMeta.id;
            const progress = state.userProgress[storageId];
            const modeText = state.gameMode === 'story' ? 'Hikaye Modu' : 'Serbest Mod';
            const displayTitle = epData.title || state.activeEpisodeMeta.titleDisplay;
            const displayDesc = epData.desc || "Bilgini test etmeye hazƒ±r mƒ±sƒ±n?";

            let html = `
                <div class="w-full max-w-md fade-in">
                    <button onclick="setView('episodeSelect')" class="mb-6 text-slate-400 hover:text-white flex items-center gap-2 text-sm transition-colors">
                        <div class="bg-slate-800 p-1 rounded-full"><i data-lucide="arrow-left" width="16"></i></div> B√∂l√ºmler
                    </button>
                    
                    <div class="text-center mb-8 glass-panel p-6 rounded-2xl relative overflow-hidden">
                        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-1 bg-gradient-to-r from-transparent via-blue-500 to-transparent"></div>
                        <span class="text-[10px] font-bold bg-slate-900 px-2 py-1 rounded text-blue-400 border border-slate-700 uppercase tracking-widest">${modeText}</span>
                        <h2 class="text-2xl font-bold mt-3 text-white">${displayTitle}</h2>
                        <p class="text-slate-400 text-sm mt-1 max-w-xs mx-auto">${displayDesc}</p>
                    </div>
                    
                    <div class="grid gap-4">
            `;

            ['kolay', 'orta', 'zor'].forEach((level, idx) => {
                const isLocked = state.gameMode === 'story' && !progress.unlocked[level];
                const score = progress.scores[level];
                
                const colors = {
                    kolay: { border: 'border-green-500', text: 'text-green-400', icon: 'text-green-500', bg: 'hover:bg-green-900/20' },
                    orta: { border: 'border-yellow-500', text: 'text-yellow-400', icon: 'text-yellow-500', bg: 'hover:bg-yellow-900/20' },
                    zor: { border: 'border-red-500', text: 'text-red-400', icon: 'text-red-500', bg: 'hover:bg-red-900/20' }
                };
                
                const c = colors[level];
                const baseClass = isLocked 
                    ? 'opacity-60 grayscale cursor-not-allowed bg-slate-800/50' 
                    : `glass-panel cursor-pointer btn-hover hover:border-l-8 ${c.bg}`;
                
                const icon = isLocked ? 'lock' : 'play-circle';

                html += `
                    <div onclick="${isLocked ? '' : `startQuiz('${level}')`}" 
                        class="${baseClass} p-5 rounded-xl border-l-4 ${isLocked ? 'border-slate-600' : c.border} transition-all flex justify-between items-center relative overflow-hidden"
                        style="animation-delay: ${idx * 0.1}s">
                        <div>
                            <h3 class="text-lg font-bold uppercase tracking-widest ${c.text} flex items-center gap-2">
                                ${level}
                            </h3>
                            <div class="flex items-center gap-3 mt-1 text-sm text-slate-400">
                                <span class="font-mono text-xs bg-slate-800 px-2 py-0.5 rounded border border-slate-700">${POINTS[level]} Puan</span>
                                ${score > 0 ? `<span class="flex items-center gap-1 text-yellow-200 bg-yellow-500/10 px-2 py-0.5 rounded border border-yellow-500/20"><i data-lucide="star" width="10"></i> ${score}</span>` : ''}
                            </div>
                        </div>
                        <i data-lucide="${icon}" class="${isLocked ? 'text-slate-500' : 'text-white'} w-8 h-8 stroke-1"></i>
                    </div>
                `;
            });

            if (state.gameMode === 'story') {
                html += `<div class="text-center text-xs text-slate-500 mt-6 flex justify-center items-center gap-1 bg-slate-900/50 py-2 rounded-lg mx-auto px-4 w-max border border-slate-800"><i data-lucide="info" width="12"></i> Kilidi a√ßmak i√ßin %60 ba≈üarƒ± gerekir.</div>`;
            }

            html += `</div></div>`;
            container.innerHTML = html;
        }

        function renderQuiz(container) {
            if (!container) container = document.getElementById('app');
            const currentQ = state.quiz.questions[state.quiz.currentQIndex];
            const progressPercent = ((state.quiz.currentQIndex) / state.quiz.questions.length) * 100;
            const streak = state.quiz.streak;

            container.innerHTML = `
                <div class="w-full max-w-lg min-h-screen flex flex-col justify-center py-4">
                    <div class="mb-6 fade-in relative">
                        <div class="flex justify-between items-end text-slate-300 text-xs font-bold tracking-wider mb-2">
                            <span class="bg-slate-800 px-2 py-1 rounded border border-slate-700">SORU ${state.quiz.currentQIndex + 1} / ${state.quiz.questions.length}</span>
                            
                            ${streak > 1 ? `
                                <div class="flex flex-col items-center animate-bounce">
                                    <span class="text-orange-400 text-[10px]">SERƒ∞!</span>
                                    <span class="text-orange-500 font-black text-xl">x${streak}</span>
                                </div>
                            ` : ''}
                            
                            <span class="bg-slate-800 px-2 py-1 rounded border border-slate-700 text-blue-300">PUAN: ${state.quiz.score}</span>
                        </div>
                        <div class="h-2 bg-slate-800 rounded-full overflow-hidden border border-slate-700">
                            <div class="progress-fill h-full bg-gradient-to-r from-blue-500 to-cyan-400 shadow-[0_0_10px_rgba(59,130,246,0.5)]" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>

                    <div class="glass-panel p-6 sm:p-8 rounded-2xl relative fade-in shadow-2xl">
                        <div class="absolute top-0 left-0 w-full h-1 rounded-t-2xl ${state.activeDifficulty === 'kolay' ? 'bg-green-500' : state.activeDifficulty === 'orta' ? 'bg-yellow-500' : 'bg-red-500'}"></div>
                        
                        <h3 class="text-xl sm:text-2xl font-semibold mb-8 leading-relaxed text-white drop-shadow-sm">
                            ${currentQ.soru}
                        </h3>

                        <div class="grid gap-3">
                            ${currentQ.secenekler.map((opt, idx) => `
                                <button id="btn-${idx}" onclick="handleAnswer(${idx})" 
                                    class="option-btn w-full p-4 text-left bg-slate-800/50 hover:bg-slate-700 border border-slate-600 rounded-xl transition-all flex items-center gap-4 group btn-hover active:scale-[0.98]">
                                    <span class="w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-lg bg-slate-900 text-slate-400 font-bold text-sm border border-slate-700 group-hover:border-slate-500 group-hover:text-white transition-colors">
                                        ${String.fromCharCode(65 + idx)}
                                    </span>
                                    <span class="text-slate-200 font-medium">${opt}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderResult(container) {
            const successRate = (state.quiz.correctCount / state.quiz.questions.length) * 100;
            const isPassed = successRate >= 60;
            const color = isPassed ? 'text-green-500' : 'text-red-500';
            const borderColor = isPassed ? 'border-green-500' : 'border-red-500';
            const icon = isPassed ? 'trophy' : 'frown';
            const title = isPassed ? 'Harika ƒ∞≈ü!' : 'Biraz Daha Gayret';

            let html = `
                <div class="w-full max-w-md text-center fade-in flex flex-col justify-center min-h-[90vh] py-8">
                    
                    ${!state.isReviewing ? `
                    <div class="glass-panel p-8 rounded-3xl border-t-4 ${borderColor} shadow-2xl relative overflow-hidden mb-6">
                        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-full bg-gradient-to-b ${isPassed ? 'from-green-500/10' : 'from-red-500/10'} to-transparent pointer-events-none"></div>
                        <div class="relative z-10">
                            <div class="mb-6 inline-block p-4 rounded-full bg-slate-900 ring-4 ring-white/5 shadow-lg animate-bounce-slow">
                                <i data-lucide="${icon}" class="${color}" width="48" height="48"></i>
                            </div>
                            <h2 class="text-3xl font-extrabold mb-2 text-white">${title}</h2>
                            <p class="text-slate-400 text-sm mb-6">${isPassed ? 'B√∂l√ºm√º ba≈üarƒ±yla tamamladƒ±n.' : 'Tekrar deneyerek ba≈üarabilirsin.'}</p>
                            <div class="grid grid-cols-2 gap-4 mb-8">
                                <div class="bg-slate-900/80 p-4 rounded-2xl border border-slate-700/50 backdrop-blur-sm">
                                    <p class="text-slate-500 text-[10px] uppercase tracking-widest font-bold">Toplam Puan</p>
                                    <p class="text-3xl font-black text-blue-400 mt-1">${state.quiz.score}</p>
                                </div>
                                <div class="bg-slate-900/80 p-4 rounded-2xl border border-slate-700/50 backdrop-blur-sm">
                                    <p class="text-slate-500 text-[10px] uppercase tracking-widest font-bold">Doƒüruluk</p>
                                    <p class="text-3xl font-black text-white mt-1">${Math.round(successRate)}<span class="text-sm align-top opacity-50">%</span></p>
                                </div>
                            </div>
                            <button onclick="toggleReview()" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold mb-3 transition-all btn-hover flex justify-center items-center gap-2 border border-slate-600">
                                <i data-lucide="eye" width="18"></i> Cevaplarƒ± ƒ∞ncele
                            </button>
                            <button onclick="generateShareLink()" class="w-full bg-green-600 hover:bg-green-500 text-white py-3 rounded-xl font-bold mb-3 transition-all btn-hover flex justify-center items-center gap-2 border border-green-600 shadow-lg shadow-green-900/20">
                                <i data-lucide="share-2" width="18"></i> Skoru Payla≈ü
                            </button>
                            <button onclick="setView('levelSelect')" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold transition-all shadow-lg shadow-blue-900/20 btn-hover flex justify-center items-center gap-2">
                                ${isPassed ? 'Devam Et' : 'Tekrar Dene'} <i data-lucide="arrow-right" width="18"></i>
                            </button>
                        </div>
                    </div>
                    ` : ''}

                    ${state.isReviewing ? `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-white">Cevap Anahtarƒ±</h3>
                            <button onclick="toggleReview()" class="bg-slate-800 p-2 rounded-full hover:bg-slate-700 transition text-slate-400 hover:text-white">
                                <i data-lucide="x" width="20"></i>
                            </button>
                        </div>
                        <div class="space-y-4 mb-6 text-left max-h-[60vh] overflow-y-auto pr-2">
                            ${state.quiz.history.map((item, i) => `
                                <div class="glass-panel p-4 rounded-xl border-l-4 ${item.isCorrect ? 'border-green-500' : 'border-red-500'}">
                                    <p class="text-xs text-slate-400 mb-1">Soru ${i + 1}</p>
                                    <p class="font-semibold text-sm mb-3 text-white">${item.question}</p>
                                    <div class="grid gap-2 text-xs">
                                        <div class="flex items-center gap-2 ${item.isCorrect ? 'text-green-400' : 'text-red-400 font-bold'}">
                                            <i data-lucide="${item.isCorrect ? 'check-circle' : 'x-circle'}" width="14"></i>
                                            Senin Cevabƒ±n: ${item.userOpt}) ${item.userOptText}
                                        </div>
                                        ${!item.isCorrect ? `
                                            <div class="flex items-center gap-2 text-green-400 font-bold bg-green-900/20 p-2 rounded border border-green-500/20">
                                                <i data-lucide="check" width="14"></i>
                                                Doƒüru Cevap: ${item.correctOpt}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="toggleReview()" class="w-full bg-slate-700 text-white py-3 rounded-xl font-bold hover:bg-slate-600 transition-colors">
                            √ñzete D√∂n
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
            container.innerHTML = html;
            lucide.createIcons();
        }

        init();

    </script>
</body>
</html>
